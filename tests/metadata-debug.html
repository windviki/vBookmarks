<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元数据显示调试页面</title>
    <link rel="stylesheet" href="../neat.css">
    <link rel="stylesheet" href="../sync-styles.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .test-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 2px solid #28a745;
            padding-bottom: 5px;
        }
        .issue-report {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
            margin: 5px 0;
            display: inline-block;
        }
        .status.broken {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.working {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .metadata-config {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .config-item {
            margin: 10px 0;
        }
        .config-item label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        .config-item input, .config-item select {
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #tree, #results {
            border: 1px solid #ccc;
            padding: 10px;
            background: #fafafa;
            border-radius: 4px;
            margin: 10px 0;
        }
        .bookmark-metadata {
            border: 1px solid green !important;
        }
        .meta-badge {
            border: 1px solid orange !important;
        }
        .debug-info {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="debug-section">
        <div class="test-title">元数据显示问题调试</div>
        <div class="issue-report">
            <strong>问题描述：</strong>元信息只有添加日期badge显示，选项里的访问日期和点击次数都显示不了
        </div>

        <div class="metadata-config">
            <h3>元数据设置模拟</h3>
            <div class="config-item">
                <label>显示添加日期：</label>
                <input type="checkbox" id="showAddedDate" checked>
            </div>
            <div class="config-item">
                <label>显示访问日期：</label>
                <input type="checkbox" id="showLastAccessed">
            </div>
            <div class="config-item">
                <label>显示点击次数：</label>
                <input type="checkbox" id="showClickCount">
            </div>
            <div class="config-item">
                <label>模拟数据：</label>
                <button onclick="simulateBookmarkData()">生成模拟书签数据</button>
                <button onclick="clearData()">清除数据</button>
            </div>
        </div>

        <div class="debug-info">
            <h3>调试信息</h3>
            <div id="metadata-debug"></div>
        </div>
    </div>

    <div class="debug-section">
        <div class="test-title">书签树视图测试</div>
        <div id="tree">
            <ul>
                <li>
                    <a href="#" class="tree-item-link" data-bookmark-id="test-1">
                        <div class="favicon-container">
                            <img src="https://www.google.com/favicon.ico" width="16" height="16" alt="">
                        </div>
                        <i>Google - 测试添加日期</i>
                    </a>
                </li>
                <li>
                    <a href="#" class="tree-item-link" data-bookmark-id="test-2">
                        <div class="favicon-container">
                            <img src="https://www.github.com/favicon.ico" width="16" height="16" alt="">
                        </div>
                        <i>GitHub - 测试完整元数据</i>
                    </a>
                </li>
            </ul>
        </div>

        <div style="margin-top: 10px;">
            <span class="status working" id="tree-added-date">添加日期：待测试</span>
            <span class="status broken" id="tree-accessed-date">访问日期：待测试</span>
            <span class="status broken" id="tree-click-count">点击次数：待测试</span>
        </div>
    </div>

    <div class="debug-section">
        <div class="test-title">搜索结果视图测试</div>
        <div id="results">
            <ul>
                <li>
                    <a href="#" class="tree-item-link" data-bookmark-id="test-3">
                        <div class="favicon-container">
                            <img src="https://www.stackoverflow.com/favicon.ico" width="16" height="16" alt="">
                        </div>
                        <i>Stack Overflow - 测试元数据显示</i>
                    </a>
                </li>
            </ul>
        </div>

        <div style="margin-top: 10px;">
            <span class="status working" id="results-added-date">添加日期：待测试</span>
            <span class="status broken" id="results-accessed-date">访问日期：待测试</span>
            <span class="status broken" id="results-click-count">点击次数：待测试</span>
        </div>
    </div>

    <script>
        // 模拟BookmarkMetadataManager
        class MockMetadataManager {
            constructor() {
                this.metadata = new Map();
            }

            setMetadata(bookmarkId, data) {
                this.metadata.set(bookmarkId, {
                    clickCount: data.clickCount || 0,
                    addedDate: data.addedDate || Date.now(),
                    lastAccessed: data.lastAccessed || Date.now() - 86400000, // 1天前
                    ...data
                });
            }

            getMetadata(bookmarkId) {
                return this.metadata.get(bookmarkId) || {
                    clickCount: 0,
                    addedDate: Date.now(),
                    lastAccessed: null
                };
            }
        }

        // 初始化模拟数据
        window.metadataManager = new MockMetadataManager();

        function simulateBookmarkData() {
            // 模拟不同类型的书签数据
            window.metadataManager.setMetadata('test-1', {
                clickCount: 0,
                addedDate: Date.now() - 172800000, // 2天前
                lastAccessed: null
            });

            window.metadataManager.setMetadata('test-2', {
                clickCount: 128,
                addedDate: Date.now() - 2592000000, // 30天前
                lastAccessed: Date.now() - 3600000 // 1小时前
            });

            window.metadataManager.setMetadata('test-3', {
                clickCount: 42,
                addedDate: Date.now() - 604800000, // 7天前
                lastAccessed: Date.now() - 1800000 // 30分钟前
            });

            updateMetadataDisplay();
            updateDebugInfo();
        }

        function clearData() {
            window.metadataManager.metadata.clear();
            updateMetadataDisplay();
            updateDebugInfo();
        }

        function getMetadataSettings() {
            return {
                showAddedDate: document.getElementById('showAddedDate').checked,
                showLastAccessed: document.getElementById('showLastAccessed').checked,
                showClickCount: document.getElementById('showClickCount').checked
            };
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleDateString();
        }

        function getCompactDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return '今天';
            if (diffDays === 1) return '昨天';
            if (diffDays < 7) return `${diffDays}天前`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)}周前`;
            return date.toLocaleDateString();
        }

        function getBookmarkMetadataHTML(bookmarkId) {
            if (!bookmarkId) return '';

            const settings = getMetadataSettings();
            const metadata = window.metadataManager.getMetadata(bookmarkId);

            if (!settings.showAddedDate && !settings.showLastAccessed && !settings.showClickCount) {
                return '';
            }

            let metadataHtml = '';

            if (settings.showClickCount && metadata.clickCount > 0) {
                const clickTitle = `点击次数: ${metadata.clickCount}`;
                metadataHtml += `<span class="meta-badge clicks" title="${clickTitle}">${metadata.clickCount}</span>`;
            }

            if (settings.showAddedDate && metadata.addedDate) {
                const dateStr = formatDate(metadata.addedDate);
                const addedTitle = `添加日期: ${dateStr}`;
                metadataHtml += `<span class="meta-badge date" title="${addedTitle}">${getCompactDate(metadata.addedDate)}</span>`;
            }

            if (settings.showLastAccessed && metadata.lastAccessed) {
                const dateStr = formatDate(metadata.lastAccessed);
                const accessedTitle = `访问日期: ${dateStr}`;
                metadataHtml += `<span class="meta-badge accessed" title="${accessedTitle}">${getCompactDate(metadata.lastAccessed)}</span>`;
            }

            if (metadataHtml) {
                return `<div class="bookmark-metadata">${metadataHtml}</div>`;
            }

            return '';
        }

        function updateMetadataDisplay() {
            // 更新所有书签的元数据显示
            const bookmarkLinks = document.querySelectorAll('[data-bookmark-id]');
            bookmarkLinks.forEach(link => {
                const bookmarkId = link.getAttribute('data-bookmark-id');
                const existingMetadata = link.querySelector('.bookmark-metadata');

                if (existingMetadata) {
                    existingMetadata.remove();
                }

                const metadataHTML = getBookmarkMetadataHTML(bookmarkId);
                if (metadataHTML) {
                    link.insertAdjacentHTML('beforeend', metadataHTML);
                }
            });

            updateStatus();
        }

        function updateStatus() {
            const settings = getMetadataSettings();

            // 检查添加日期
            const addedDateBadges = document.querySelectorAll('.meta-badge.date');
            const addedDateWorking = settings.showAddedDate && addedDateBadges.length > 0;

            // 检查访问日期
            const accessedDateBadges = document.querySelectorAll('.meta-badge.accessed');
            const accessedDateWorking = settings.showLastAccessed && accessedDateBadges.length > 0;

            // 检查点击次数
            const clickCountBadges = document.querySelectorAll('.meta-badge.clicks');
            const clickCountWorking = settings.showClickCount && clickCountBadges.length > 0;

            // 更新状态显示
            document.getElementById('tree-added-date').textContent = `添加日期：${addedDateWorking ? '显示正常' : '不显示'}`;
            document.getElementById('tree-added-date').className = `status ${addedDateWorking ? 'working' : 'broken'}`;

            document.getElementById('tree-accessed-date').textContent = `访问日期：${accessedDateWorking ? '显示正常' : '不显示'}`;
            document.getElementById('tree-accessed-date').className = `status ${accessedDateWorking ? 'working' : 'broken'}`;

            document.getElementById('tree-click-count').textContent = `点击次数：${clickCountWorking ? '显示正常' : '不显示'}`;
            document.getElementById('tree-click-count').className = `status ${clickCountWorking ? 'working' : 'broken'}`;

            document.getElementById('results-added-date').textContent = `添加日期：${addedDateWorking ? '显示正常' : '不显示'}`;
            document.getElementById('results-added-date').className = `status ${addedDateWorking ? 'working' : 'broken'}`;

            document.getElementById('results-accessed-date').textContent = `访问日期：${accessedDateWorking ? '显示正常' : '不显示'}`;
            document.getElementById('results-accessed-date').className = `status ${accessedDateWorking ? 'working' : 'broken'}`;

            document.getElementById('results-click-count').textContent = `点击次数：${clickCountWorking ? '显示正常' : '不显示'}`;
            document.getElementById('results-click-count').className = `status ${clickCountWorking ? 'working' : 'broken'}`;
        }

        function updateDebugInfo() {
            const debug = document.getElementById('metadata-debug');
            const settings = getMetadataSettings();
            const metadataCount = window.metadataManager.metadata.size;

            let html = `
                <p><strong>当前设置：</strong></p>
                <ul>
                    <li>显示添加日期：${settings.showAddedDate}</li>
                    <li>显示访问日期：${settings.showLastAccessed}</li>
                    <li>显示点击次数：${settings.showClickCount}</li>
                </ul>
                <p><strong>模拟数据：</strong></p>
                <ul>
                    <li>存储的元数据条数：${metadataCount}</li>
                </ul>
            `;

            if (metadataCount > 0) {
                html += '<p><strong>详细数据：</strong></p>';
                window.metadataManager.metadata.forEach((data, id) => {
                    html += `<li><strong>书签 ${id}：</strong> `;
                    html += `点击次数: ${data.clickCount}, `;
                    html += `添加日期: ${new Date(data.addedDate).toLocaleString()}, `;
                    html += `访问日期: ${data.lastAccessed ? new Date(data.lastAccessed).toLocaleString() : '无'}`;
                    html += '</li>';
                });
            }

            debug.innerHTML = html;
        }

        // 监听设置变化
        document.getElementById('showAddedDate').addEventListener('change', updateMetadataDisplay);
        document.getElementById('showLastAccessed').addEventListener('change', updateMetadataDisplay);
        document.getElementById('showClickCount').addEventListener('change', updateMetadataDisplay);

        // 初始化
        window.addEventListener('load', function() {
            simulateBookmarkData();
        });
    </script>
</body>
</html>